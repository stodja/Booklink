<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="Seamless managing of digital book collections.">
  <meta name="theme-color" content="#222222">
  <title>Booklink</title>
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
  <noscript>
    <center>For the functionality of this site it is necessary to enable JavaScript.
    Here are the <a href="https://www.enable-javascript.com/" style="color:white; display:inline-block;">
    instructions how to enable JavaScript in your web browser</a></center>
   </noscript>
  <style>

    @font-face {
      font-family: "Poppins";
      src: url("https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLCz7Z1xlFQ.woff2") format("woff2");
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      /* display: none; <- Crashes Chrome on hover */
      -webkit-appearance: none;
      margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }

    input[type=number] {
      appearance:textfield; /* Firefox */
    }

    input:focus {
      outline:none
    }

    #booklist-url-input {
      padding-top: 7px;
      padding-bottom: 7px;
    }

    input {
    transition: opacity 0.5s;
    justify-content: center; /* Center buttons horizontally */
    align-items: center; /* Center buttons vertically */
    border: 2px solid;
    border-color: #ffffff;
    border-radius: 7px;
    text-align:center;
    font-size:16px;
    font-family: "Poppins", Arial, sans-serif; /* Use Poppins font */
    width: 140px;
    color: #ffffff;
    background-color: #141414;
    margin-right: 7.5px;
    }

    #page-selector {
    justify-content: center; /* Center buttons horizontally */
    align-items: center; /* Center buttons vertically */
    border: 2px solid;
    border-color: #ffffff;
    border-radius: 7px;
    text-align:right;
    font-size:14px;
    font-family: "Poppins", Arial, sans-serif; /* Use Poppins font */
    width: 30px;
    color: #ffffff;
    background-color: #141414;
    }

    body {
      justify-content: center; /* Center buttons horizontally */
      align-items: center; /* Center buttons vertically */
      background-color: #141414;
      color: #ffffff;
      font-family: "Poppins", Arial, sans-serif;
      padding: 20px;
      margin: 0;
      overflow: hidden;
      overflow-y: scroll;
      align-items: center; /* Center vertically */
      justify-content: center; /* Center horizontally */
    }

    #book-container {
      margin-bottom: 20px;
    }

    #book-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Center buttons horizontally */
      align-items: center; /* Center buttons vertically */
    }

    button {
      background-color: #141414;
      color: #ffffff;
      border: 2px solid white;
      padding: 7px 17px;
      margin: 10px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 7px;
      opacity: 1; /* Set initial opacity */
      transition: opacity 0.5s; /* Add fade-out animation */
      font-family: "Poppins", Arial, sans-serif; /* Use Poppins font */
    }

    button:hover {
      transition: background-color 250ms ease;
      background-color: #eb0000;
      opacity: 0.99;
    }

    .prev-next-button {
      display: none; /* Hide the previous and next buttons */
    }

    canvas {
      display: flex;
      padding: 5%;
      object-fit: contain;
      padding: 20px; /* Add padding to the canvas */
      opacity: 0; /* Set initial opacity to 0 */
      transition: opacity 0.5s; /* Add fade-in animation */
      width: auto;
      position: relative;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.5s;
    }

    .header {
      display: flex;
      justify-content: center;
      align-content: center;
      align-items: baseline;
      text-align: center;
      margin-top:20px;
      grid-template-columns: 1fr 1fr 1fr;
      column-gap: 15px;
    }

    h1 {
      font-family: "Poppins", Arial, sans-serif;
      font-size: 77px;
      font-weight: normal;
      margin-top: 0;
      text-align: center;
      text-shadow: 0 0 0px #ffffff, 0 0 0px #ffffff, 0 0 04px #ffffff; 
      cursor: pointer;
    }

    #url-input {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    a {
        transition: opacity 0.5s;
        border: solid 3px #eb0000;
        -webkit-border-radius: 6px;
        -moz-border-radius: 6px;
        border-radius: 6px;
        text-decoration: none;
        background-color: #eb0000;
    }

    a:hover {
      opacity: 0.7;
    }

    #about {
      font-size: 20px;
      padding-bottom: 10%;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.5s;
    }

    #badge {
      position: absolute;
      bottom: 0.5%;
      right: 1%;
    }

    ::selection {
      background-color: #eb0000;
      color: white;
    }
    
    ::-moz-selection {
      background-color: #eb0000;
      color: white;
    }

  </style>
</head>
<body>
  <div class="header">
  <img id="logo" src="assets/images/logo.png" style="border:0;height:66px;">
  <h1 id="booklink-header">Booklink</h1> <!-- Add the "Booklink" text header -->
  </div>

  <!-- Add input box and submit button -->
  <div id="url-input">
    <input type="text" id="booklist-url-input" placeholder="Books list URL">
    <button id="submit-button">Submit</button>
  </div>

  <div id="book-container"></div>
  <div id="book-list"></div>

  <div id="about"><a href="assets/pages/about.html" style="color:white">About</a></div>

  <div id="badge">
  <img id="w3c" style="border:0;width:88px;height:31px" src="http://jigsaw.w3.org/css-validator/images/vcss" alt="CSS Validated by W3C">
  <img id="gpl" style="border:0;width:88px;height:31px" src=assets/images/gpl.png>
  </div>


  <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script>
    console.log('%c Hold Up! ', 'font-family: "Sans"; font-weight: bold; font-size: 100px; color: red');
    console.warn("%c Do not copy/paste anything in here, you are probably being scammed!", "font-size: 20px")
    console.warn("%c Unless you understand exactly what you are doing, close this window and stay safe.", "font-size: 20px")
    console.warn("%c (If you're a developer, then you're on your own idk)", "font-size: 10px")
    var buttons = []; // Array to store all the buttons

    // Add click event listener to the submit button
    
    tippy('#submit-button', {
        content: '<a href = "https://pastebin.com/raw/FcsKcZBF" style="color:white; display:inline-block;">This</a> is an example file, to show its structure',
        allowHTML: true,
        maxWidth: 'none',
        interactive: true,
      });

    tippy('#w3c', {
        content: '<a href="https://jigsaw.w3.org/css-validator/about.html" style="color:white; display:inline-block;">Validated CSS</a>',
        allowHTML: true,
        interactive: true,
      });

      tippy('#gpl', {
        content: 'Project under <a href="https://www.gnu.org/licenses/gpl-3.0.html" style="color:white; display:inline-block;">GPLv3</a>',
        allowHTML: true,
        interactive: true,
      });

    tippy('#booklink-header', {
        content: 'Return to the main page'
      });

    var submitButton = document.getElementById("submit-button");
    submitButton.addEventListener("click", function() {
      var booklistUrlInput = document.getElementById("booklist-url-input").value;
      fetch(booklistUrlInput)
        .then(response => response.text())
        .then(data => {
          var bookUrls = data.trim().split("\n");
          showBookList(bookUrls);
        })
        .catch(error => {
          console.error("Error fetching book list:", error);
        });
      });

    function showBookList(bookUrls) {
      var bookListContainer = document.getElementById("book-list");
      bookListContainer.innerHTML = ""; // Clear previous book list

      bookUrls.forEach(function(bookUrl) {
        if (/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/gm.test(bookUrl) == true) {
          var bookTitle = getBookTitle(bookUrl);
          var button = document.createElement("button");
          button.innerText = bookTitle;
          button.addEventListener("click", function() {
            buttons.forEach(function(btn) {
              btn.style.opacity = 0; // Apply fade-out animation to all buttons
              submitButton.style.opacity = 0;
              document.getElementById("booklist-url-input").style.opacity = 0;
              document.getElementById("about").style.opacity = 0;
            });
            setTimeout(function() {
              displayBook(bookUrl);
            }, 500); // Wait for the animation to complete
          });
          buttons.push(button); // Add button to the array
          bookListContainer.appendChild(button);
        }
      });
    }

    function getBookTitle(bookUrl) {
      // Extract the book title from the URL or customize it as needed
      // Example: Assuming the URL is in the format "https://example.com/book-title.epub"
      var bookTitle = bookUrl.split("/").pop().split(".")[0];

      // Decode the URI components
      bookTitle = decodeURIComponent(bookTitle)

      // Capitalize the starting letter of every word
      bookTitle = bookTitle.replace(/\b\w/g, function(l) {
        return l.toUpperCase();
      });

      return bookTitle;
    }

    function displayBook(bookUrl) {
      var bookContainer = document.getElementById("book-container");
      var booklinkHeader = document.getElementById("booklink-header");
      bookContainer.innerHTML = "";

      if (bookUrl.endsWith(".pdf")) {
        // Use PDF.js to render the PDF
        var canvas = document.createElement("canvas");
        bookContainer.appendChild(canvas);

        var pageNumberContainer = document.createElement("div");
        pageNumberContainer.id = "page-number-container"; // Add an ID to the container
        bookContainer.appendChild(pageNumberContainer);

        var currentPage = 1; // Track the current page number
        var pdfInstance = null;

        var loadingTask = pdfjsLib.getDocument(bookUrl);
        loadingTask.promise.then(function(pdf) {
          pdfInstance = pdf;

          if (document.cookie.match(new RegExp('(^| )' + String(getBookTitle(bookUrl) + '=([^;]+)')))) {
            var match = (document.cookie.match(new RegExp('(^| )' + String(getBookTitle(bookUrl) + '=([^;]+)'))));
            if (match) {
              currentPage = match[2];
              pageNumber = match[2];
              renderPage(parseInt(match[2]));
            }
          }
          else {
            renderPage(currentPage); // Render the initial page
          }
          
          // Attach keyboard event listeners
          document.addEventListener("keydown", function(event) {
            if (document.activeElement && (document.activeElement.tagName.toLowerCase() != 'input' )){
               
              if (event.keyCode === 39 || event.keyCode === 117 || event.keyCode === 228) {
                // Right arrow or key code 228 (next page)
                if (currentPage < pdf.numPages) {
                  currentPage++;
                  renderPage(currentPage);
                  pageSelector.value = currentPage
                }
              } else if (event.keyCode === 37 || event.keyCode === 116 || event.keyCode === 227) {
                // Left arrow or key code 227 (previous page)
                if (currentPage > 1) {
                  currentPage--;
                  renderPage(currentPage);
                  pageSelector.value = currentPage
                }
              }
            }
              
          });

          // Add page number selector and visualizer
          var pageSelector = document.createElement("input");
          
          pageSelector.id = "page-selector";
          pageSelector.type = "text";
          pageSelector.min = 1;
          pageSelector.max = pdf.numPages;
          pageSelector.value = currentPage;
          pageSelector.addEventListener("change", function() {
            var selectedPage = parseInt(pageSelector.value);
            if (!isNaN(selectedPage) && selectedPage >= 1 && selectedPage <= pdf.numPages) {
              currentPage = selectedPage;
              renderPage(selectedPage);
            }
          });
          pageNumberContainer.appendChild(pageSelector);

          var pageVisualizer = document.createElement("span");
          pageVisualizer.id = "page-visualizer"; // Add an ID to the visualizer
          pageVisualizer.textContent = " / " + pdf.numPages;
          pageNumberContainer.appendChild(pageVisualizer);

        });

        function renderPage(pageNumber) {
          document.cookie = String(getBookTitle(bookUrl) + '=' + pageNumber + ';expires=' + new Date(2147483647 * 1000).toUTCString() + '; Samesite=Lax');
          pdfInstance.getPage(pageNumber).then(function(page) {
            var viewport = page.getViewport({ scale: 1 });
            var canvas = document.querySelector("canvas");
            var context = canvas.getContext("2d");
            var viewportWidth = window.innerWidth - window.innerWidth / 30;

            var viewportOptions = viewport.clone({ scale: 1 });
            var scale = viewportWidth / viewportOptions.width;
            var scaledViewport = viewportOptions.clone({ scale: scale });

            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            var renderContext = {
              canvasContext: context,
              viewport: scaledViewport
            };

            page.render(renderContext).promise.then(function() {
              canvas.style.opacity = 1; // Set opacity to 1 for fade-in animation
            });

            // Update the page visualizer
            var pageVisualizer = document.getElementById("page-visualizer");
            pageVisualizer.textContent = " / " + pdf.numPages;
          });
        }

        // Add click event listener to the "Booklink" header
        booklinkHeader.addEventListener("click", function() {
          canvas.style.opacity = 0; // Apply fade-out animation to the canvas
          if (canvas.parentNode === bookContainer) {
            bookContainer.removeChild(canvas);
          }
          buttons.forEach(function(btn) {
            btn.style.opacity = 1; // Make the buttons visible
            document.getElementById("submit-button").style.opacity = 1;
            document.getElementById("booklist-url-input").style.opacity = 1;
            document.getElementById("about").style.opacity = 1;
          });

          // Remove the page number container
          pageNumberContainer.parentNode.removeChild(pageNumberContainer);
        });
      }
    }
  </script>
</body>
</html>
